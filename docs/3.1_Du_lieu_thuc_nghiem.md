# 3.1. Dữ liệu thực nghiệm

Mục tiêu của chương này: mô tả rõ dữ liệu được sinh ra trong quá trình huấn luyện và suy luận, cách thu thập, lưu trữ, cùng các chỉ số theo dõi để đánh giá mô hình RL trong game.

## 3.1.1. Mục tiêu thu thập dữ liệu

- Đảm bảo mỗi phiên chạy (episode) có log đầy đủ: trạng thái đầu, chuỗi hành động, reward theo thời gian, trạng thái kết thúc.
- Ghi nhận biến động hiệu năng (FPS, thời gian suy luận) để kiểm soát chi phí tính toán và ảnh hưởng đến gameplay.
- Lưu checkpoint mô hình kèm metadata (seed, cấu hình hyper-parameter, commit) để tái hiện kết quả.
- Tạo bộ số liệu so sánh giữa các thiết lập (baseline scripted AI vs RL, tham số PPO khác nhau) trên cùng kịch bản bản đồ.

## 3.1.2. Nguồn và loại dữ liệu

- **Gameplay/RL log:**
  - Observation vector cho mỗi bước (obs_t).
  - Action được chọn (a_t) và xác suất/logit (để phân tích entropy, policy shift).
  - Reward tức thời (r_t) và reward tích lũy (R_t).
  - Cờ `done` và thông tin kết thúc episode (thời gian sống, quái bị tiêu diệt, sát thương gây ra/nhận vào).
- **Thông tin môi trường:** seed, cấu hình spawn, tốc độ game time scale, độ khó.
- **Thông số hệ thống:** FPS, latency inference, số lần fallback sang scripted AI.
- **Checkpoint & metadata:** phiên bản mô hình, ngày giờ, commit hash, tham số PPO (theo [ml-agents-configs/ppo_vampire.yaml](ml-agents-configs/ppo_vampire.yaml)).

## 3.1.3. Thiết lập môi trường thực nghiệm

- **Phần mềm:** Unity Editor của dự án (LTS hiện hành), gói ML-Agents/Inference phiên bản theo manifest, C# runtime .NET 4.x (tương ứng với cấu hình project). Kiểm tra trực tiếp trong Packages/manifest.json và Packages/packages-lock.json để đảm bảo đồng nhất.
- **Phần cứng tham chiếu:** CPU 4–8 cores, RAM ≥16 GB, GPU có CUDA (nếu huấn luyện trên máy cục bộ) hoặc sử dụng CPU inference cho so sánh. Ghi rõ cấu hình thực tế trong báo cáo chạy.
- **Hệ điều hành:** Windows (môi trường làm việc hiện tại) với driver GPU cập nhật ổn định.

## 3.1.4. Kịch bản và tham số chạy

- **Chế độ Training (PPO):**
  - Cấu hình trong [ml-agents-configs/ppo_vampire.yaml](ml-agents-configs/ppo_vampire.yaml): batch size, buffer size, learning rate, gamma, lambda, clipping, entropy.
  - Số episode tối thiểu: 200–500 cho run thử; log từng 1–5 episode để phân tích sớm.
  - Time scale: tăng 5–20x trong training để thu thập dữ liệu nhanh, nhưng cần theo dõi độ ổn định vật lý.
- **Chế độ Inference:**
  - Game chạy ở time scale 1x; bật HUD đo FPS và latency suy luận.
  - So sánh 2 profile: (1) RL policy mới nhất; (2) Scripted AI baseline.
- **Biến thử nghiệm:** seed ngẫu nhiên, mật độ spawn, loại quái (melee/ranged/boss), số lượng agent song song (n_envs) khi huấn luyện.

## 3.1.5. Cách ghi nhận và lưu trữ

- **Định dạng đề xuất:**
  - Step-level log: JSON Lines, mỗi record chứa {episode_id, step, obs_hash, action, prob/logit, reward, done, fps, latency_ms}.
  - Episode summary: CSV hoặc JSON tổng hợp {episode_id, survival_time, kills, damage_dealt, damage_taken, total_reward, avg_latency_ms}.
- **Vị trí lưu:**
  - Thư mục `results/` cho log và biểu đồ; tách theo ngày/run id (`results/YYYYMMDD_runXX`).
  - Thư mục `models/` cho checkpoint; đặt kèm file metadata (`.meta.json`) ghi seed, config, commit, môi trường.
- **Ghi hình (tùy chọn):** xuất video ngắn cho một số episode mẫu để quan sát hành vi.

## 3.1.6. Chỉ số đánh giá chính

- **Hiệu năng tác vụ:** thời gian sống trung bình (survival time), số quái tiêu diệt, tỷ lệ thắng (nếu có điều kiện thắng/thua), DPS gây ra/nhận vào.
- **Chất lượng chính sách RL:** reward trung bình trên 1000 bước, entropy, KL giữa policy hiện tại và phiên bản trước, tỷ lệ fallback scripted AI.
- **Hiệu năng hệ thống:** FPS trung bình/thấp nhất, latency suy luận (p50/p95), thời gian huấn luyện mỗi cập nhật.
- **Ổn định huấn luyện:** độ dao động reward, tỉ lệ gradient clip, tỉ lệ loss policy/value giảm dần.

## 3.1.7. Kiểm soát chất lượng dữ liệu

- Loại bỏ episode lỗi (crash, NaN, physics explode) và ghi chú nguyên nhân.
- Kiểm tra độ phủ hành động: đảm bảo không bị collapse vào một hành động đơn.
- So sánh log giữa các run với cùng seed để phát hiện regression.
- Tạo script kiểm tra định dạng log (schema) và cảnh báo khi thiếu trường bắt buộc.
