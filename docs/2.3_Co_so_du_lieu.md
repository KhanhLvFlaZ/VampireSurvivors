# 2.3. Cơ sở dữ liệu (Co-op Survivors RL)

Mục tiêu: Làm rõ cấu trúc và quan hệ giữa dữ liệu game co-op (runtime/telemetry multi-player) và dữ liệu RL đa agent (training/inference), gồm các bảng/collection chính, khóa, chỉ mục và cách đồng bộ với Unity/ML-Agents.

## 2.3.1. Nguyên tắc & mô hình dữ liệu

- Phân tách lớp dữ liệu (logical tiers):
  - **Gameplay runtime (telemetry/match log)**: phiên người chơi, sự kiện, tổng kết trận.
  - **RL training/inference**: experience tuples, loss/reward log, checkpoint, behavior profile.
- Bất biến vs phiên bản hóa:
  - **Bất biến**: SessionEvent, RLExperience, StateSnapshot (dùng hash kiểm toàn vẹn).
  - **Phiên bản hóa**: TrainingRun, Checkpoint, BehaviorProfile, Metrics (gắn version/seed).
- Định danh & truy vết:
  - Bắt buộc **session_id** cho gameplay và **run_id** cho training; mọi bảng log kèm timestamp/tick/step.
  - Chuẩn hóa timezone (UTC), định dạng ISO-8601; tick/step là số nguyên tăng.
- Tối ưu truy vấn & lưu trữ:
  - Log/experience dùng lưu trữ dạng hàng (row store); checkpoint/model dùng blob nhị phân kèm hash + size.
  - Chỉ mục khuyến nghị: (session_id, tick), (run_id, step), (run_id, version), (ckpt_id, created_at).
- Mức trừu tượng mô hình dữ liệu:
  - **Conceptual**: phiên chơi ↔ sự kiện ↔ tổng kết; run ↔ experience ↔ checkpoint ↔ profile ↔ inference log.
  - **Logical**: quan hệ ER với khóa ngoại; khóa tổng hợp (session_id, tick) cho log trình tự.
  - **Physical**: SQL (PostgreSQL) cho quan hệ; blob store (S3/disk) cho state/checkpoint; NoSQL tùy chọn cho truy vấn phân tích.
- Nhất quán giữa Unity và ML-Agents:
  - Unity ghi session_id/tick; Trainer ghi run_id/step; mapping profile_id ↔ ckpt_id để inference trong game.
  - Định dạng payload: JSON cho sự kiện; tensor/obs serialized (npz/pt) cho StateSnapshot; ONNX/pt cho model.
- Tuân thủ bảo mật và tối giản PII:
  - Pseudonym hóa player_id, tránh lưu PII; phân quyền đọc/ghi checkpoint và log.
  - Lưu vết audit: ai tạo checkpoint, khi nào, từ run_id nào.

## 2.3.2. Mô hình khái niệm & ERD

### Mô hình khái niệm

- **Miền Gameplay (telemetry/session):** PlayerSession → SessionEvent (dòng sự kiện thời gian) → MatchSummary (tổng kết trận).
- **Miền Training (RL run):** TrainingRun → {RLExperience, RewardLog, LossLog} → Checkpoint (phiên bản model) → BehaviorProfile (gắn nhãn rollout).
- **Miền Inference (runtime):** BehaviorProfile → InferenceLog (hành động/giá trị) gắn với PlayerSession để so sánh hiệu năng.
- **Trạng thái & quan sát:** RLExperience tham chiếu StateSnapshot (state, next_state) để tái tạo trajectory; snapshot lưu blob/feature vector sau encoder.
- **Định danh & liên kết:** session_id cho gameplay, run_id cho training; ckpt_id ↔ profile_id cho inference; tick/step + timestamp để đồng bộ thời gian.

### ERD (khái niệm, triển khai SQL/NoSQL tùy chọn)

```plantuml
@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam classAttributeIconSize 0

entity PlayerSession {
  * session_id : uuid
  --
  player_id : string
  start_time : datetime
  end_time   : datetime
  build_version : string
}

entity SessionEvent {
  * event_id : uuid
  --
  session_id : uuid
  tick : long
  event_type : string
  payload_json : text
}

entity MatchSummary {
  * match_id : uuid
  --
  session_id : uuid
  duration : float
  kills : int
  damage_taken : float
  reward_total : float
}

entity TrainingRun {
  * run_id : uuid
  --
  start_time : datetime
  end_time : datetime
  env_version : string
  algo : string
  hyperparams_json : text
}

entity RLExperience {
  * exp_id : uuid
  --
  run_id : uuid
  tick : long
  state_ref : uuid
  action : string
  reward : float
  next_state_ref : uuid
  done : bool
}

entity StateSnapshot {
  * state_id : uuid
  --
  hash : string
  blob_path : string
  size_bytes : int
  created_at : datetime
}

entity RewardLog {
  * reward_id : uuid
  --
  run_id : uuid
  tick : long
  reward : float
  reason : string
}

entity LossLog {
  * loss_id : uuid
  --
  run_id : uuid
  step : long
  policy_loss : float
  value_loss : float
  entropy : float
  lr : float
}

entity Checkpoint {
  * ckpt_id : uuid
  --
  run_id : uuid
  version : string
  path : string
  created_at : datetime
  eval_score : float
}

entity BehaviorProfile {
  * profile_id : uuid
  --
  ckpt_id : uuid
  tag : string
  notes : string
  created_at : datetime
}

entity InferenceLog {
  * inf_id : uuid
  --
  session_id : uuid
  profile_id : uuid
  tick : long
  action : string
  value : float
  log_prob : float
}

PlayerSession ||--o{ SessionEvent : contains
PlayerSession ||--o{ MatchSummary : summarizes
TrainingRun ||--o{ RLExperience : records
TrainingRun ||--o{ LossLog : logs
TrainingRun ||--o{ RewardLog : logs
TrainingRun ||--o{ Checkpoint : outputs
Checkpoint ||--o{ BehaviorProfile : versions
BehaviorProfile ||--o{ InferenceLog : used by
RLExperience ||--|| StateSnapshot : state
RLExperience ||--|| StateSnapshot : next_state
@enduml
```

## 2.3.3. Triển khai và lưu trữ

- SQL (PostgreSQL) phù hợp cho log cấu trúc và khóa ngoại; tạo index trên (session_id, tick), (run_id, step), (run_id, version).
- Blob store (S3/Local disk) cho StateSnapshot.blob_path và Checkpoint.path; lưu hash để kiểm tra toàn vẹn.
- Nếu dùng NoSQL (Mongo/Elastic), giữ các trường khóa (session_id, run_id, tick) để truy vấn; vẫn nên tách collection cho experience và inference log.

## 2.3.4. Đồng bộ với Unity/ML-Agents

- Runtime Unity ghi SessionEvent và MatchSummary qua Job/Coroutines; flush định kỳ để tránh mất dữ liệu.
- ML-Agents Trainer ghi RLExperience, RewardLog, LossLog; checkpoint lưu theo version kèm eval_score.
- Inference trong game chọn BehaviorProfile (theo ckpt) và log InferenceLog để so sánh hiệu năng giữa các profile.

## 2.3.5. Quản trị và vòng đời dữ liệu

- TTL/archiving: log chi tiết (SessionEvent, RLExperience) đặt TTL sau X ngày; Checkpoint/BehaviorProfile giữ lại bản tốt nhất (eval_score cao).
- Phiên bản hóa: TrainingRun và Checkpoint versioning giúp tái hiện thí nghiệm; lưu hyperparams và seed.
- Bảo mật: mã hóa đường dẫn blob; ẩn player_id hoặc thay bằng hash cho dữ liệu nhạy cảm.

## Phụ lục: Biểu đồ tuần tự UC3 - Hợp tác Co-op

```plantuml
@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam actorStyle awesome
skinparam sequenceMessageAlign center

actor "Player 1" as P1
actor "Player 2" as P2
participant GameManager
participant ProximityDetector as Prox
participant CombatSystem
participant HUDController
participant NetworkManager

== Phát hiện hợp tác ==
P1 -> GameManager : Di chuyển trong map
P2 -> GameManager : Di chuyển trong map
GameManager -> Prox : Kiểm tra khoảng cách
Prox --> GameManager : Trong team radius?

alt Trong phạm vi hợp tác
  GameManager -> GameManager : Áp dụng team bonuses
  GameManager -> HUDController : Hiển thị "Team Bonus"
else Ngoài phạm vi
  GameManager -> GameManager : Không bonus
end

== Giao tranh và chia sẻ XP ==
P1 -> CombatSystem : Tấn công enemy gần nhất
CombatSystem -> CombatSystem : Kiểm tra cooldown / tầm đánh
CombatSystem -> CombatSystem : Gây damage / kết liễu enemy
CombatSystem -> GameManager : Sự kiện enemy defeated
GameManager -> GameManager : Tính XP chia sẻ (70% mỗi player +10% bonus nếu gần)
GameManager -> HUDController : Popup "+Shared XP" cho P1, P2

== Loot chia sẻ ==
GameManager -> GameManager : Tạo loot (gem/coin)
P2 -> GameManager : Nhặt loot
GameManager -> GameManager : Nếu P1 low HP → chia đều coin/gem
GameManager -> HUDController : Cập nhật inventory/coin cả hai

== Đồng bộ Co-op (nếu online) ==
opt Online mode
  GameManager -> NetworkManager : Broadcast state/bonus
  NetworkManager --> GameManager : Ack / reconcile
end

@enduml
```
