@startuml
!pragma charset UTF-8
autonumber
skinparam style strictuml
skinparam shadowing false
skinparam sequenceArrowThickness 1
skinparam sequenceMessageAlign center
skinparam ParticipantPadding 15
skinparam BoxPadding 8
skinparam defaultFontName Arial
skinparam defaultFontSize 12

title Vòng lặp Suy luận RL trong Gameplay (Inference Mode)

participant "LevelManager" as Engine
participant "Character" as Player
participant "RLEnvironment" as Env
participant "StateEncoder" as Obs
participant "RLMonster" as Agent
participant "ModelManager" as Model
participant "EntityManager" as EntityMgr
participant "PerformanceMonitor" as Perf

== Khởi tạo Game ==
Engine -> Engine: Init(levelBlueprint)
activate Engine

Engine -> Model: LoadCheckpoint(checkpointPath)
activate Model
Model -> Model: LoadONNXModel()
Model -> Model: LoadMetadata()
Model --> Engine: model loaded
deactivate Model

Engine -> Env: Initialize(entityManager, playerCharacter)
activate Env
Env -> Env: Setup SpatialHashGrid
Env --> Engine: environment ready
deactivate Env

Engine -> Agent: SetInferenceMode(true)
activate Agent
Agent -> Agent: DisableTraining()
Agent -> Agent: SetExplorationRate(0) // greedy
Agent --> Engine: inference mode active
deactivate Agent

Engine -> Perf: StartMonitoring()
activate Perf
Perf --> Engine: monitoring started
deactivate Perf
deactivate Engine

== Game Loop (mỗi frame/tick) ==
loop mỗi frame (Update/FixedUpdate)
  
  Engine -> Engine: deltaTime tick
  
  group Thu thập Quan sát
    Engine -> Player: GetCurrentHealth() / GetPosition()
    activate Player
    Player --> Engine: playerState
    deactivate Player
    
    Engine -> Env: CaptureGameState()
    activate Env
    Env -> Env: GetPlayerBehaviorMetrics()
    Env -> Env: QueryNearbyEntities(spatialGrid)
    Env -> Env: GetNearbyMonsters(observationRadius)
    Env -> Env: GetNearbyCollectibles()
    Env --> Engine: RLGameState
    deactivate Env
    
    Engine -> Obs: EncodeState(gameState)
    activate Obs
    Obs -> Obs: EncodePlayerState()
    Obs -> Obs: EncodeMonsterState()
    Obs -> Obs: EncodeNearbyMonsters()
    Obs -> Obs: NormalizeState()
    Obs --> Engine: float[] observations
    deactivate Obs
  end
  
  par Xử lý từng AI Agent
    loop cho mỗi RLMonster
      
      group Suy luận Hành động (Neural Network Inference)
        Engine -> Agent: RequestDecision(observations)
        activate Agent
        
        Agent -> Perf: StartInferenceTimer()
        activate Perf
        deactivate Perf
        
        Agent -> Model: Predict(observations)
        activate Model
        Model -> Model: ONNXRuntime.Run()
        Model -> Model: GetOutputTensor()
        Model --> Agent: actionProbabilities
        deactivate Model
        
        Agent -> Agent: SelectGreedyAction() // argmax, no exploration
        
        Agent -> Perf: EndInferenceTimer()
        activate Perf
        Perf -> Perf: CheckInferenceTime() // must be < 16ms
        deactivate Perf
        
        Agent --> Engine: MonsterAction
        deactivate Agent
      end
      
      group Cập nhật Vị trí & Hành vi
        Engine -> Agent: ApplyAction(action)
        activate Agent
        Agent -> Agent: ValidateAction()
        Agent -> Agent: UpdateMovement(deltaTime)
        Agent -> Agent: UpdateAnimator(action)
        Agent --> Engine: actionApplied
        deactivate Agent
        
        Engine -> EntityMgr: ProcessMonsterUpdate(monster)
        activate EntityMgr
        EntityMgr -> EntityMgr: CheckPlayerCollision()
        EntityMgr -> EntityMgr: CheckProjectileCollisions()
        EntityMgr -> EntityMgr: UpdateSpatialHashGrid()
        EntityMgr --> Engine: collisionEvents
        deactivate EntityMgr
      end
      
    end
  end
  
  group Performance Monitoring
    Engine -> Perf: RecordFrameMetrics(deltaTime, activeAgents)
    activate Perf
    Perf -> Perf: UpdateFrameTimeHistory()
    Perf -> Perf: CheckMemoryUsage()
    
    alt frameTime > maxFrameTimeMs
      Perf -> Perf: TriggerGracefulDegradation()
      Perf -> Engine: SuggestReduceAgentCount()
    end
    deactivate Perf
  end
  
  opt debug mode
    Engine -> Perf: LogDebugInfo(observations, actions)
    activate Perf
    Perf -> Perf: SaveInferenceMetrics()
    deactivate Perf
  end
  
  note right of Engine
    Unity rendering pipeline
    tự động xử lý:
    - Sprite updates
    - Animation state machines
    - Camera follow
    - UI rendering
  end note
  
end

== Game Over / Level Complete ==
Engine -> Perf: EndMonitoring()
activate Perf
Perf -> Perf: CalculateFinalStatistics()
Perf -> Perf: LogSessionSummary()
Perf --> Engine: sessionMetrics
deactivate Perf

opt debug mode
  Engine -> Perf: ExportPerformanceReport(sessionId)
  activate Perf
  Perf -> Perf: SerializeMetrics()
  Perf --> Engine: report saved
  deactivate Perf
end

note over Engine
  **LevelManager**
  Scripts/Gameplay/LevelManager.cs
  - Init(levelBlueprint)
  - Update() game loop
  - Spawn monsters/items
end note

note over Player
  **Character**
  Scripts/Gameplay/Character.cs
  - Player character
  - GetPosition() / GetCurrentHealth()
  - Target for AI monsters
end note

note over Env
  **RLEnvironment**
  Scripts/RL/Core/RLEnvironment.cs
  - CaptureGameState()
  - SpatialHashGrid integration
  - observationRadius = 10f
end note

note over Obs
  **StateEncoder**
  Scripts/RL/Core/StateEncoder.cs
  - EncodeState() real-time
  - Same normalization as training
  - Must be < 2ms per call
end note

note over Agent
  **RLMonster**
  Scripts/RL/Integration/RLMonster.cs
  - **Inference mode only**
  - RequestDecision()
  - Greedy action selection
  - No training/gradient
end note

note over Model
  **ModelManager**
  Scripts/RL/Core/ModelManager.cs
  - LoadCheckpoint()
  - ONNX inference only
  - No backward pass
end note

note over EntityMgr
  **EntityManager**
  Scripts/Gameplay/EntityManager.cs
  - Manages all game entities
  - Collision detection
  - SpatialHashGrid updates
end note

note over Perf
  **PerformanceMonitor**
  Scripts/RL/Core/PerformanceMonitor.cs
  - Real-time monitoring
  - maxFrameTimeMs = 16ms
  - Graceful degradation
end note

@enduml
