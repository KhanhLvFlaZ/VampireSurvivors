@startuml
autonumber
skinparam style strictuml
skinparam shadowing false
skinparam sequenceArrowThickness 1
skinparam sequenceMessageAlign center
skinparam ParticipantPadding 15
skinparam BoxPadding 8

title Vòng lặp Huấn luyện RL - Chi tiết

actor "RLTrainingManager" as Trainer
participant "StateEncoder" as Obs
participant "RLMonster" as Agent
participant "ModelManager" as Model
participant "RLEnvironment" as Env
participant "PerformanceMonitor" as Perf

== Khởi động Episode ==
Trainer -> Trainer: StartNewEpisode()
activate Trainer
Trainer -> Env: ResetEnvironment()
activate Env
Env -> Env: ClearMonsterState()
Env --> Trainer: episodeReady
deactivate Env
Trainer -> Perf: BeginEpisodeMonitoring(episodeNum)
activate Perf
Perf --> Trainer: monitoring started
deactivate Perf
deactivate Trainer

== Vòng lặp Huấn luyện (mỗi step) ==
loop cho đến khi terminal (done=true)
  
  group Collect Observations
    Trainer -> Env: CaptureGameState()
    activate Env
    Env -> Env: GetPlayerState()
    Env -> Env: GetNearbyMonsters()
    Env -> Env: GetNearbyCollectibles()
    Env --> Trainer: RLGameState
    deactivate Env
    
    Trainer -> Obs: EncodeState(gameState)
    activate Obs
    Obs -> Obs: EncodePlayerState()
    Obs -> Obs: EncodeMonsterState()
    Obs -> Obs: NormalizeState()
    Obs --> Trainer: float[] observations
    deactivate Obs
  end
  
  group Chọn Hành động (Policy)
    Trainer -> Agent: RequestDecision(observations)
    activate Agent
    Agent -> Agent: GetCurrentBehavior()
    Agent -> Model: Predict(observations)
    activate Model
    Model -> Model: Forward pass (neural network)
    Model --> Agent: actionProbabilities
    deactivate Model
    Agent -> Agent: SampleAction() // stochastic during training
    Agent --> Trainer: MonsterAction
    deactivate Agent
  end
  
  group Áp dụng vào Môi trường
    Trainer -> Env: ApplyAction(monster, action)
    activate Env
    Env -> Env: UpdateMonsterPosition()
    Env -> Env: CheckCollisions()
    Env -> Env: CalculateReward()
    Env -> Env: IsEpisodeComplete()
    Env --> Trainer: StepResult(reward, nextState, done)
    deactivate Env
  end
  
  group Update Policy
    Trainer -> Agent: StoreExperience(state, action, reward, nextState, done)
    activate Agent
    Agent -> Agent: AddToReplayBuffer()
    deactivate Agent
    
    alt buffer size >= batch size
      Trainer -> Agent: TrainFromBuffer()
      activate Agent
      Agent -> Agent: SampleBatch()
      Agent -> Model: ComputeLoss(batch)
      activate Model
      Model -> Model: Forward pass
      Model -> Model: Calculate TD-error / Policy gradient
      Model --> Agent: loss
      deactivate Model
      
      Agent -> Model: BackwardPass()
      activate Model
      Model -> Model: Compute gradients
      Model -> Model: ApplyOptimizer()
      Model --> Agent: weights updated
      deactivate Model
      deactivate Agent
    end
  end
  
  group Log Metrics
    Trainer -> Perf: RecordStep(reward, loss, inferenceTime)
    activate Perf
    Perf -> Perf: UpdatePerformanceMetrics()
    Perf -> Perf: CheckPerformanceThresholds()
    deactivate Perf
  end
  
end

== Kết thúc Episode ==
Trainer -> Trainer: EndCurrentEpisode()
activate Trainer
Trainer -> Perf: EndEpisodeMonitoring()
activate Perf
Perf -> Perf: CalculateEpisodeMetrics()
Perf -> Perf: LogEpisodeStatistics()
Perf --> Trainer: episodeMetrics
deactivate Perf

alt episode % checkpointInterval == 0
  Trainer -> Model: SaveCheckpoint(episodeNum, avgReward)
  activate Model
  Model -> Model: SaveModelWeights(onnxPath)
  Model -> Model: SaveMetadata(jsonPath)
  Model --> Trainer: checkpoint saved
  deactivate Model
end
deactivate Trainer

note over Trainer
  **RLTrainingManager**
  Scripts/RL/Core/RLTrainingManager.cs
  - StartTraining() / StopTraining()
  - StartNewEpisode()
  - maxEpisodes, maxStepsPerEpisode
  - checkpointInterval
end note

note over Obs
  **StateEncoder**
  Scripts/RL/Core/StateEncoder.cs
  - EncodeState(RLGameState)
  - Normalize observations
  - TOTAL_STATE_SIZE = 59 floats
end note

note over Agent
  **RLMonster**
  Scripts/RL/Integration/RLMonster.cs
  - RequestDecision()
  - StoreExperience()
  - Replay buffer for training
end note

note over Model
  **ModelManager**
  Scripts/RL/Core/ModelManager.cs
  - SaveCheckpoint() / LoadCheckpoint()
  - ONNX model management
  - Version control
end note

note over Env
  **RLEnvironment**
  Scripts/RL/Core/RLEnvironment.cs
  - CaptureGameState()
  - CalculateReward()
  - IsEpisodeComplete()
end note

note over Perf
  **PerformanceMonitor**
  Scripts/RL/Core/PerformanceMonitor.cs
  - RecordStep() metrics
  - CheckPerformanceThresholds()
  - maxFrameTimeMs = 16ms (60 FPS)
end note

@enduml
